const dotenv = require('dotenv')
const { getPhpVersionVulnerabilitiesOfBitbucketWorkspace } = require('../index')
const { writeToCsv } = require('../src/csv')

dotenv.config()

const username = process.env.BITBUCKET_USERNAME
const appPassword = process.env.BITBUCKET_APP_PASSWORD

const workspace = process.argv[2]
const versionsCsvUrl = process.argv[3]

if (!username) {
  console.error('Please provide a BITBUCKET_USERNAME environment variable')
  process.exitCode = 1;
} else if (!appPassword) {
  console.error('Please provide a BITBUCKET_APP_PASSWORD environment variable')
  process.exitCode = 1;
} else if (!workspace) {
  console.error('Please specify a Bitbucket workspace')
  process.exitCode = 1;
} else if (!versionsCsvUrl) {
  console.error('Please provide a URL for a CSV of PHP versions used in Docker images')
  process.exitCode = 1;
} else {
  getPhpVersionVulnerabilitiesOfBitbucketWorkspace(
    username,
    appPassword,
    workspace,
    versionsCsvUrl
  ).then(writeToCsv)
}
