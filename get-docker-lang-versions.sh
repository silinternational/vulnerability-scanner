#!/bin/bash

printf 'Docker image,PHP version,NodeJS version,Python version\n' > docker-lang-versions.txt

while IFS= read -r dockerImage; do
  docker pull "$dockerImage"
  if [ $? -eq 0 ]; then
    echo "Pulled $dockerImage"
  else
    echo "Unknown docker image: $dockerImage"
    continue
  fi

  docker run --rm --platform=linux/amd64 --entrypoint php "$dockerImage" -v &>/dev/null
  if [ $? -eq 0 ]; then
    phpVersion=$(docker run --rm --platform=linux/amd64 --entrypoint php "$dockerImage" -r "echo PHP_MAJOR_VERSION . '.' . PHP_MINOR_VERSION;")
  else
    phpVersion="NONE"
  fi

  docker run --rm --platform=linux/amd64 --entrypoint node "$dockerImage" -v &>/dev/null
  if [ $? -eq 0 ]; then
    nodeVersion=$(docker run --rm --platform=linux/amd64 --entrypoint node "$dockerImage" -e "console.log(process.version.match(/^(v?\d+)\./)[1])")
  else
    nodeVersion="NONE"
  fi

  docker run --rm --platform=linux/amd64 --entrypoint python "$dockerImage" --version &>/dev/null
  if [ $? -eq 0 ]; then
    pythonVersion=$(docker run --rm --platform=linux/amd64 --entrypoint python "$dockerImage" -c 'import sys; print(str(sys.version_info[0])+"."+str(sys.version_info[1]))')
  else
    pythonVersion="NONE"
  fi

  printf '%s,%s,%s,%s\n' "$dockerImage" "$phpVersion" "$nodeVersion" "$pythonVersion" >> docker-lang-versions.txt
done
