const github = require('./github')
const semverSatisfies = require('semver/functions/satisfies')

const getSecurityVulnerabilitiesForPhpDependency = async (token, dependency) => {
  const vulnerabilities = await github.getSecurityVulnerabilitiesForPackageUsingCache(
    token,
    dependency.name
  )
  return vulnerabilities.filter(vulnerability => semverSatisfies(
    dependency.version,
    vulnerability.vulnerableVersionRange
  ))
}

/**
 * Get the list of security vulnerabilities affecting a given GitHub organization's
 * repositories.
 *
 * @param token {string} A GitHub personal access token
 * @param org {string} A GitHub organization's name
 * @returns {Promise<Object.<string, array>>}
 */
module.exports.getSecurityVulnerabilitiesForGitHubOrg = async (token, org) => {
  console.log(`Scanning for vulnerabilities in GitHub org. ${org}`)
  const results = {}
  
  const repos = await github.listRepos(org, token)
  for (let i = 0; i < repos.length; i++) {
    const repo = repos[i]
    const vulnerabilities = await getSecurityVulnerabilitiesForGitHubRepo(token, repo)
    if (vulnerabilities === undefined) {
      results[repo] = null
      continue
    }
    results[repo] = []
    for (let j = 0; j < vulnerabilities.length; j++) {
      results[repo].push(vulnerabilities[j])
    }
  }
  
  return results
}

const getSecurityVulnerabilitiesForGitHubRepo = async (token, repo) => {
  console.log(`Looking for vulnerabilities in GitHub ${repo}`)
  const results = []
  
  const dependencies = await github.getDependenciesOfRepo(token, repo)
  if (dependencies === undefined) {
    console.log('(unable to determine dependencies)')
    return undefined
  }
  for (let i = 0; i < dependencies.length; i++) {
    const dependency = dependencies[i]
    console.log(`Checking ${dependency.name} [${dependency.version}]`)
    
    const vulnerabilities = await getSecurityVulnerabilitiesForPhpDependency(
      token,
      dependency
    )
    
    for (let j = 0; j < vulnerabilities.length; j++) {
      const vulnerability = vulnerabilities[j]
      console.log(
        `! Found vulnerability: ${vulnerability.package.name} ${vulnerability.vulnerableVersionRange}`
      )
      results.push(vulnerability)
    }
  }
  
  return results
}
