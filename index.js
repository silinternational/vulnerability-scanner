const semverSatisfies = require('semver/functions/satisfies')
const { convertToCsvString } = require('./src/csv')
const github = require('./src/github')

const getSecurityVulnerabilitiesForPhpDependency = async (token, dependency) => {
  const vulnerabilities = await github.getSecurityVulnerabilitiesForPackageUsingCache(
    token,
    dependency.name
  )
  return vulnerabilities.filter(vulnerability => semverSatisfies(
    dependency.version,
    vulnerability.vulnerableVersionRange
  ))
}

/**
 * Get the list of security vulnerabilities affecting a given GitHub organization's
 * repositories.
 *
 * @param token {string} A GitHub personal access token
 * @param org {string} A GitHub organization's name
 * @returns {Promise<Object.<string, array>>}
 */
const getSecurityVulnerabilitiesForGitHubOrg = async (token, org) => {
  console.log(`Scanning for vulnerabilities in GitHub org. ${org}`)
  const repos = await github.listRepos(org, token)
  return getSecurityVulnerabilitiesForGitHubRepos(token, repos)
}

/**
 * Get a list of security vulnerabilities affecting the specified GitHub repos.
 *
 * Only repos whose dependencies could be determined will be included.
 *
 * @param token {string} - A GitHub personal access token
 * @param repos {string[]} - A list of repo names
 * @returns {Promise<Object[]>}
 */
const getSecurityVulnerabilitiesForGitHubRepos = async (token, repos) => {
  const results = []
  for (let i = 0; i < repos.length; i++) {
    const repo = repos[i]
    const vulnerabilities = await getSecurityVulnerabilitiesForGitHubRepo(token, repo)
    if (Array.isArray(vulnerabilities)) {
      results.push(...vulnerabilities)
    }
  }
  return results
}

/**
 * Get the security vulnerabilities for the specified GitHub repo.
 *
 * NOTE: This includes the name of the specified repo in an added `repo` field
 * in the data about each vulnerability.
 *
 * @param token {string} - A GitHub personal access token
 * @param repo {string} - A GitHub repo (formatted as "owner/library")
 * @returns {Promise<{identifiers, inspectedOn, packageName, repo, severity, vulnerableVersionRange}[]>}
 */
const getSecurityVulnerabilitiesForGitHubRepo = async (token, repo) => {
  console.log(`Looking for vulnerabilities in GitHub ${repo}`)
  const results = []
  
  const dependencies = await github.getDependenciesOfRepo(token, repo)
  if (dependencies === undefined) {
    console.log('(unable to determine dependencies)')
    return undefined
  }
  for (let i = 0; i < dependencies.length; i++) {
    const dependency = dependencies[i]
    console.log(`Checking ${dependency.name} [${dependency.version}]`)
    
    const vulnerabilities = await getSecurityVulnerabilitiesForPhpDependency(
      token,
      dependency
    )
    
    for (let j = 0; j < vulnerabilities.length; j++) {
      const vulnerability = vulnerabilities[j]
      console.log(
        `! Found vulnerability: ${vulnerability.packageName} ${vulnerability.vulnerableVersionRange}`
      )
      vulnerability.repo = repo
      results.push(vulnerability)
    }
  }
  
  return results
}

module.exports = {
  convertToCsvString,
  getSecurityVulnerabilitiesForGitHubOrg
}
