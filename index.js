const semverSatisfies = require('semver/functions/satisfies')
const { convertToCsvString } = require('./src/csv')
const bitbucket = require('./src/bitbucket')
const github = require('./src/github')

/**
 * Get the security vulnerabilities for the specified Bitbucket repo. It will
 * return an array of vulnerabilities, or `undefined` if the Bitbucket repo's
 * dependencies could not be determined.
 *
 * NOTE: The data returned about each vulnerability will include a `repo` field
 * with given repo name.
 *
 * NOTE 2: The GitHub token is needed for calls to check for published
 * security vulnerabilities.
 *
 * @param {string} bitbucketUsername - A Bitbucket username
 * @param {string} bitbucketAppPassword - A Bitbucket app password
 * @param {string} githubToken - A GitHub personal access token
 * @param {string} repo - A Bitbucket repo (formatted as "owner/library")
 * @returns {Promise<undefined | {repo, detailsUrl, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]>}
 */
const getSecurityVulnerabilitiesForBitbucketRepo = async (
  bitbucketUsername,
  bitbucketAppPassword,
  githubToken,
  repo
) => {
  console.log(`Looking for vulnerabilities in Bitbucket ${repo}`)
  const phpDependencies = await bitbucket.getPhpDependenciesOfRepo(
    bitbucketUsername,
    bitbucketAppPassword,
    repo
  )
  if (phpDependencies === undefined) {
    console.log('(unable to determine PHP dependencies)')
    return undefined
  }
  const phpVulnerabilities = await getSecurityVulnerabilitiesForPhpDependencies(
    githubToken,
    phpDependencies
  )
  return phpVulnerabilities.map(vulnerability => addRepoName(repo, vulnerability))
}

/**
 * Get a list of security vulnerabilities affecting the specified Bitbucket
 * repos.
 *
 * Only repos whose dependencies could be determined will be included.
 *
 * @param {string} bitbucketUsername - A Bitbucket username
 * @param {string} bitbucketAppPassword - A Bitbucket app password
 * @param {string} githubToken - A GitHub personal access token
 * @param {string[]} repos - The list of Bitbucket repos (e.g. ["owner/library"])
 * @returns {Promise<undefined | {repo, detailsUrl, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]>}
*/
const getSecurityVulnerabilitiesForBitbucketRepos = async (
  bitbucketUsername,
  bitbucketAppPassword,
  githubToken,
  repos
) => {
  const results = []
  for (let i = 0; i < repos.length; i++) {
    const repo = repos[i]
    const vulnerabilities = await getSecurityVulnerabilitiesForBitbucketRepo(
      bitbucketUsername,
      bitbucketAppPassword,
      githubToken,
      repo
    )
    if (Array.isArray(vulnerabilities)) {
      results.push(...vulnerabilities)
    }
  }
  return results
}

/**
 * Get the list of security vulnerabilities affecting a given Bitbucket
 * workspace's repos.
 *
 * @param {string} bitbucketUsername - A Bitbucket username
 * @param {string} bitbucketAppPassword - A Bitbucket app password
 * @param {string} githubToken - A GitHub personal access token
 * @param {string} workspace - A Bitbucket workspace (aka organization)
 * @returns {Promise<{repo, detailsUrl, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]>}
 */
const getSecurityVulnerabilitiesForBitbucketWorkspace = async (
  bitbucketUsername,
  bitbucketAppPassword,
  githubToken,
  workspace
) => {
  console.log(`Scanning for vulnerabilities in Bitbucket workspace ${workspace}`)
  const repos = await bitbucket.listRepos(
    bitbucketUsername,
    bitbucketAppPassword,
    workspace
  )
  return getSecurityVulnerabilitiesForBitbucketRepos(
    bitbucketUsername,
    bitbucketAppPassword,
    githubToken,
    repos
  )
}

const getSecurityVulnerabilitiesForPhpDependency = async (githubToken, dependency) => {
  const vulnerabilities = await github.getSecurityVulnerabilitiesForPackageUsingCache(
    githubToken,
    dependency.name
  )
  return vulnerabilities.filter(vulnerability => versionSatisfiesRange(
    dependency.version,
    vulnerability.vulnerableVersionRange
  ))
}

const versionSatisfiesRange = (version, gitHubVulnerableVersionRange) => {
  /*
   * NOTE: GitHub's `vulnerableVersionRange` uses a comma to separate the two
   * version constraints of a range:
   * https://docs.github.com/en/free-pro-team@latest/graphql/reference/objects#securityvulnerability
   * 
   * However, npm's semver doesn't know what to do with that comma. Removing it
   * seems to result in a version range that npm's semver can understand.
   */
  const npmSemverRange = gitHubVulnerableVersionRange.replace(',', '')
  return semverSatisfies(version, npmSemverRange)
}

/**
 * Get the list of security vulnerabilities affecting a given GitHub organization's
 * repositories.
 *
 * @param {string} githubToken - A GitHub personal access token
 * @param {string} org - A GitHub organization's name
 * @returns {Promise<{repo, detailsUrl, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]>}
 */
const getSecurityVulnerabilitiesForGitHubOrg = async (githubToken, org) => {
  console.log(`Scanning for vulnerabilities in GitHub org. ${org}`)
  const repos = await github.listRepos(githubToken, org)
  return getSecurityVulnerabilitiesForGitHubRepos(githubToken, repos)
}

/**
 * Get a list of security vulnerabilities affecting the specified GitHub repos.
 *
 * Only repos whose dependencies could be determined will be included.
 *
 * @param {string} githubToken - A GitHub personal access token
 * @param {string[]} repos - A list of repo names
 * @returns {Promise<{repo, detailsUrl, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]>}
 */
const getSecurityVulnerabilitiesForGitHubRepos = async (githubToken, repos) => {
  const results = []
  for (let i = 0; i < repos.length; i++) {
    const repo = repos[i]
    const vulnerabilities = await getSecurityVulnerabilitiesForGitHubRepo(githubToken, repo)
    if (Array.isArray(vulnerabilities)) {
      results.push(...vulnerabilities)
    }
  }
  return results
}

/**
 * Get the security vulnerabilities for the specified GitHub repo. It will
 * return an array of vulnerabilities, or `undefined` if the GitHub repo's
 * dependencies could not be determined.
 *
 * NOTE: The data returned about each vulnerability will include a `repo` field
 * with given repo name.
 *
 * @param {string} githubToken - A GitHub personal access token
 * @param {string} repo - A GitHub repo (formatted as "owner/library")
 * @returns {Promise<undefined | {repo, detailsUrl, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]>}
 */
const getSecurityVulnerabilitiesForGitHubRepo = async (githubToken, repo) => {
  console.log(`Looking for vulnerabilities in GitHub ${repo}`)
  const phpDependencies = await github.getPhpDependenciesOfRepo(githubToken, repo)
  if (phpDependencies === undefined) {
    console.log('(unable to determine PHP dependencies)')
    return undefined
  }
  const phpVulnerabilities = await getSecurityVulnerabilitiesForPhpDependencies(
    githubToken,
    phpDependencies
  )
  return phpVulnerabilities.map(vulnerability => addRepoName(repo, vulnerability))
}

const addRepoName = (repo, vulnerability) => {
  // Return a new object instead of modifying the given object (which caused problems).
  return Object.assign({repo}, vulnerability)
}

/**
 *
 * @param {string} githubToken - A GitHub personal access token
 * @param {{name: string, version: string}[]} dependencies
 * @returns {Promise<Object[]>}
 */
const getSecurityVulnerabilitiesForPhpDependencies = async (githubToken, dependencies) => {
  const results = []
  for (let i = 0; i < dependencies.length; i++) {
    const dependency = dependencies[i]
    console.log(`Checking ${dependency.name} [${dependency.version}]`)
    
    const vulnerabilities = await getSecurityVulnerabilitiesForPhpDependency(
      githubToken,
      dependency
    )
    
    for (let j = 0; j < vulnerabilities.length; j++) {
      const vulnerability = vulnerabilities[j]
      console.log(
        `! Found vulnerability: ${vulnerability.packageName} ${vulnerability.vulnerableVersionRange}`
      )
      results.push(vulnerability)
    }
  }
  
  return results
}

module.exports = {
  convertToCsvString,
  getSecurityVulnerabilitiesForBitbucketRepo,
  getSecurityVulnerabilitiesForBitbucketWorkspace,
  getSecurityVulnerabilitiesForGitHubOrg,
  getSecurityVulnerabilitiesForGitHubRepo
}
