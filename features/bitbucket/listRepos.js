const { Given, When, Then } = require('@cucumber/cucumber')
const assert = require('assert')
const dotenv = require('dotenv')
const bitbucket = require('../../src/bitbucket')

dotenv.config()

const username = process.env.BITBUCKET_USERNAME
const appPassword = process.env.BITBUCKET_APP_PASSWORD
const workspace = process.env.BITBUCKET_WORKSPACE_FOR_TESTS

let repoNames = []

When('I get the list of repos', async function () {
  repoNames = await bitbucket.listRepos(
    username,
    appPassword,
    workspace
  )
})

Then('the result will be an array of strings', function () {
  if (!Array.isArray(repoNames)) {
    assert.fail('The result was this:' + JSON.stringify(repoNames))
  }
  
  if (repoNames.length < 1) {
    assert.fail('The array must have at least one entry in it (for this test)')
  }
  
  repoNames.forEach(repoName => {
    assert.strictEqual(
      typeof repoName,
      'string',
      'Expected this to be a string: ' + JSON.stringify(repoName)
    )
  })
})

Then('none of those repo names will end with {string}', function (suffix) {
  repoNames.forEach(repoName => {
    if (repoName.endsWith(suffix)) {
      assert.fail(JSON.stringify(repoName) + ' ends with ' + JSON.stringify(suffix))
    }
  })
})
