const { getHyphenatedDate } = require('./date')
const { writeToString } = require('@fast-csv/format')
const fs = require("fs")

/**
 * Convert the given list of repos' vulnerabilities to a CSV string.
 *
 * @param {{identifiers, inspectedOn, packageName, repo, severity, vulnerableVersionRange}[]} vulnerabilities
 * @returns {Promise<string>}
 */
const convertToCsvString = async vulnerabilities => {
  const dataForCsv = vulnerabilities.map(structureForCsvRow)
  return await writeToString(dataForCsv, { headers: true })
}

/**
 * Structure the given data for use in assembling a CSV string.
 *
 * @param {{identifiers, inspectedOn, packageName, repo, severity, vulnerableVersionRange}[]} vulnerability
 * @returns {Object}
 */
const structureForCsvRow = vulnerability => ({
  'Inspected on': vulnerability.inspectedOn,
  Application: vulnerability.repo,
  'Vulnerability CVE / identifier': vulnerability.identifiers[0],
  Severity: vulnerability.severity,
  'Vulnerable dependency': vulnerability.packageName,
  'Vulnerable versions': vulnerability.vulnerableVersionRange,
  'Details URL': vulnerability.detailsUrl,
})

/**
 * Write the given vulnerabilities data to a CSV file.
 *
 * @param {{identifiers, inspectedOn, packageName, repo, severity, vulnerableVersionRange}[]} vulnerabilities
 */
const writeToCsv = async vulnerabilities => {
  const hyphenatedDate = getHyphenatedDate()
  const filename = `${hyphenatedDate}.csv`
  const csvString = await convertToCsvString(vulnerabilities)
  fs.writeFileSync(filename, csvString)
  console.log('Wrote results to ' + filename)
}

module.exports = {
  convertToCsvString,
  writeToCsv
}
