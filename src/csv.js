const { getHyphenatedDate } = require('./date')
const { writeToString } = require('@fast-csv/format')
const { parseString } = require('@fast-csv/parse')
const fs = require("fs")

/**
 * Convert the given list of repos' vulnerabilities to a CSV string.
 *
 * @param {{repo, detailsUrl, ecosystem, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]} vulnerabilities
 * @returns {Promise<string>}
 */
const convertToCsvString = async vulnerabilities => {
  const dataForCsv = vulnerabilities.map(structureForCsvRow)
  return await writeToString(dataForCsv, { headers: true })
}

/**
 * Get the data from the given CSV string.
 *
 * @param {string} csvString
 * @returns {Promise<Object[]>}
 */
const readCsvString = async csvString => {
  return new Promise(function(resolve, reject) {
    const dataFromCsv = []
    parseString(csvString, { headers: true })
      .on('error', reject)
      .on('data', row => dataFromCsv.push(row))
      .on('end', () => resolve(dataFromCsv))
  })
}

/**
 * Structure the given data for use in assembling a CSV string.
 *
 * @param {{repo, detailsUrl, ecosystem, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]} vulnerability
 * @returns {Object}
 */
const structureForCsvRow = vulnerability => ({
  'Inspected on': vulnerability.inspectedOn,
  Application: vulnerability.repo,
  'Vulnerability CVE / identifier': vulnerability.identifiers[0],
  Severity: vulnerability.severity,
  Summary: vulnerability.summary,
  'Vulnerable dependency': vulnerability.packageName,
  'Vulnerable versions': vulnerability.vulnerableVersionRange,
  'Details URL': vulnerability.detailsUrl,
  'Ecosystem': vulnerability.ecosystem,
})

/**
 * Write the given vulnerabilities data to a CSV file.
 *
 * @param {{repo, detailsUrl, ecosystem, identifiers, inspectedOn, packageName, severity, summary, vulnerableVersionRange}[]} vulnerabilities
 */
const writeToCsv = async vulnerabilities => {
  const hyphenatedDate = getHyphenatedDate()
  const filename = `${hyphenatedDate}.csv`
  const csvString = await convertToCsvString(vulnerabilities)
  fs.writeFileSync(filename, csvString)
  console.log('Wrote results to ' + filename)
}

module.exports = {
  convertToCsvString,
  readCsvString,
  writeToCsv
}
