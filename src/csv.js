const { format } = require('@fast-csv/format')
const fs = require("fs")
const { getPreferredIdentifier } = require('./index')

module.exports.writeToCsv = (vulnerabilitiesByRepo) => {
  const now = new Date()
  const hyphenatedDate = now.toISOString().substr(0, 10)
  
  const filename = `${hyphenatedDate}.csv`
  const csvStream = format({ headers: true })
  const writeStream = fs.createWriteStream(filename)
  csvStream.pipe(writeStream).on('end', () => writeStream.end());
  
  const repos = Object.keys(vulnerabilitiesByRepo)
  for (let r = 0; r < repos.length; r++) {
    const repo = repos[r]
    const vulnerabilities = vulnerabilitiesByRepo[repo]
    if (!Array.isArray(vulnerabilities)) {
      continue
    }
    for (let v = 0; v < vulnerabilities.length; v++) {
      const vulnerability = vulnerabilities[v]
      const identifier = getPreferredIdentifier(vulnerability)
      csvStream.write({
        'Inspected on': hyphenatedDate,
        Application: repo,
        'Vulnerability CVE / identifier': identifier,
        Severity: vulnerability.severity,
        'Vulnerable dependency': vulnerability.package.name,
        'Vulnerable versions': vulnerability.vulnerableVersionRange
      })
    }
  }
  console.log('Wrote results to ' + filename)
  csvStream.end()
}
