const { getHyphenatedDate } = require('./date')
const { writeToString } = require('@fast-csv/format')
const fs = require("fs")
const { getPreferredIdentifier } = require('./github')

/**
 * Convert the given list of repos' vulnerabilities to a CSV string.
 *
 * @param vulnerabilitiesByRepo
 * @returns {Promise<string>}
 */
const convertToCsvString = async vulnerabilitiesByRepo => {
  const dataForCsv = structureForCsv(vulnerabilitiesByRepo)
  return await writeToString(dataForCsv, { headers: true })
}

const structureForCsv = vulnerabilitiesByRepo => {
  const hyphenatedDate = getHyphenatedDate()
  const dataForCsv = []
  const repos = Object.keys(vulnerabilitiesByRepo)
  for (let r = 0; r < repos.length; r++) {
    const repo = repos[r]
    const vulnerabilities = vulnerabilitiesByRepo[repo]
    if (!Array.isArray(vulnerabilities)) {
      continue
    }
    for (let v = 0; v < vulnerabilities.length; v++) {
      const vulnerability = vulnerabilities[v]
      const identifier = getPreferredIdentifier(vulnerability)
      dataForCsv.push({
        'Inspected on': hyphenatedDate,
        Application: repo,
        'Vulnerability CVE / identifier': identifier,
        Severity: vulnerability.severity,
        'Vulnerable dependency': vulnerability.package.name,
        'Vulnerable versions': vulnerability.vulnerableVersionRange
      })
    }
  }
  return dataForCsv
}

/**
 * Write the given vulnerabilities data to a CSV file.
 *
 * @param vulnerabilitiesByRepo
 */
const writeToCsv = async vulnerabilitiesByRepo => {
  const hyphenatedDate = getHyphenatedDate()
  const filename = `${hyphenatedDate}.csv`
  const csvString = await convertToCsvString(vulnerabilitiesByRepo)
  fs.writeFileSync(filename, csvString)
  console.log('Wrote results to ' + filename)
}

module.exports = {
  convertToCsvString,
  writeToCsv
}
