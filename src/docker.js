
const { readCsvString } = require('./csv')
const mem = require('mem')
const { request } = require('@octokit/request')

/**
 * Get the base image specified in the FROM line of the provided Dockerfile
 * contents.
 *
 * @param {string} dockerfileContents
 * @returns {undefined | string}
 */
const getBaseImageFrom = dockerfileContents => {
  if (!dockerfileContents) {
    return undefined
  }
  
  const fromLine = getFromLine(dockerfileContents)
  const fromIndex = fromLine.indexOf('FROM')
  const spaceIndex = fromLine.indexOf(' ', fromIndex)
  return fromLine.substring(spaceIndex + 1, fromLine.length).trim()
}

const getFromLine = dockerfileContents => {
  const fromIndex = dockerfileContents.indexOf('FROM')
  const fileContentStartingAtFrom = dockerfileContents.substring(
    fromIndex,
    dockerfileContents.length
  )
  const allLines = fileContentStartingAtFrom.split("\n")
  return allLines[0]
}

/**
 * Look up the PHP version used by the specified Docker image.
 *
 * Possible return values:
 * - `'UNKNOWN'` -- CSV has no entry for that Docker image.
 * - `'NONE'` -- That Docker image does not use PHP.
 * - (a PHP version string, such as `'7.2.24-0ubuntu0.18.04.7'`)
 *
 * @param {string} dockerImage -- The Docker image name, optionally with a tag
 *     specified.
 * @param {string} versionsCsvUrl -- The URL where we can retrieve a CSV file of
 *     the PHP versions used by various Docker images.
 * @returns {Promise<string>}
 */
const getPhpVersionOfImage = async (dockerImage, versionsCsvUrl) => {
  const response = await getVersionsCsvUsingCache(versionsCsvUrl)
  const versions = await readCsvString(response.data)
  const matchingEntries = versions.filter(entry => entry['Docker image'] === dockerImage)
  const matchingEntry = matchingEntries.pop() || {}
  return matchingEntry['PHP version'] || 'UNKNOWN'
}
const getPhpVersionOfImageUsingCache = mem(
  getPhpVersionOfImage,
  { cacheKey: JSON.stringify }
)

const getVersionsCsv = async versionsCsvUrl => request(`GET ${versionsCsvUrl}`)
const getVersionsCsvUsingCache = mem(
  getVersionsCsv,
  { cacheKey: JSON.stringify }
)

module.exports = {
  getBaseImageFrom,
  getPhpVersionOfImageUsingCache
}
